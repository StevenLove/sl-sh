#!/bin/bash

function log() {
	echo -e "\033[33;7m$1\033[0m $2"
}

log "> Docs Hook started"

log "Verify we have an up to date release build to generate the docs with"
cargo build --release

pushd docs

log "Build docs"
../target/release/sl-sh docify.lisp index.markdown :lang

if [[ $? != "0" ]]; then
	echo "Uncategorized forms found, not pushing. Please edit appropriate"
	echo "docstrings printed as hashmap literals above. Run"
	echo "$ cd docs && sl-sh docify.lisp index.markdown :lang to get started."
	exit 1;
fi

log "Push docs"

REMOTE=$(git config --get remote.origin.url)

rm -rf .git

if [ ! -d ".git" ]; then
   git init
fi

git checkout -b gh-pages

git remote add origin ${REMOTE}
git add --all && git commit -m "Build $(date)"
git push -u -f origin gh-pages

rm -rf .git

popd doc

log "< Docs Hook finished"
